# 大会運用ガイド - 運営用/観戦用URL分離

このドキュメントでは、Unite Draft アプリを大会で安全に使用するための運営方法を説明します。

---

## 📋 概要

### URL設計

| URL | 役割 | 権限 |
|-----|------|------|
| `/draft/:id/admin` | **運営用** | ✅ ピック操作可能<br>✅ 試合遷移可能<br>✅ 全機能利用可能 |
| `/draft/:id/view` | **観戦用** | 👁️ 表示のみ<br>🔒 ピック不可<br>🔒 試合遷移不可 |
| `/draft` | 開発/テスト用 | ローカルのみ（後方互換性） |

### 仕組み

- **同じ draft state を共有**: 運営と観戦は同じSupabaseデータを参照
- **権限制御**: URLの `mode` パラメータ（admin/view）で自動判定
- **認証不要**: URLを知っている人がアクセス可能（シンプル運用）

---

## 🚀 大会当日の運用フロー

### ステップ1: ドラフト作成（運営のみ）

1. **運営用PCで `/draft` にアクセス**
2. モックデータが自動作成され、Supabaseに保存される
3. ブラウザコンソール（F12）で Draft ID を確認:
   ```
   [saveDraftState] ✅ Successfully created new draft, ID: xxx-xxx-xxx-xxx
   ```

4. または、`localStorage` から取得:
   ```javascript
   localStorage.getItem('current_draft_id')
   // => "xxx-xxx-xxx-xxx"
   ```

### ステップ2: URLの生成と共有

Draft ID を使って以下のURLを生成します:

**運営用URL（スタッフのみに共有）:**
```
https://your-domain.com/draft/xxx-xxx-xxx-xxx/admin
```

**観戦用URL（配信・観客に共有）:**
```
https://your-domain.com/draft/xxx-xxx-xxx-xxx/view
```

💡 **Tip**: admin モードの画面右上に両方のURLが表示されます（コピペ可能）

### ステップ3: 運営側の操作

1. **運営用URLにアクセス**
2. ヘッダーに「運営URL」「観戦URL」が表示される
3. ポケモンをクリックしてピック
4. 10ピック完了後、「次の試合へ進む」ボタンで試合遷移
5. 全3試合完了まで繰り返し

### ステップ4: 観戦側の確認

1. **観戦用URLにアクセス**
2. ヘッダーに「👁️ 観戦モード」バッジが表示される
3. ポケモングリッドに「読み取り専用」表示
4. ポケモンクリック → 無効（何も起こらない）
5. 試合遷移ボタン → 表示されない
6. 運営側の操作がリアルタイムで反映される（要リロード）

---

## 🔒 安全性の確認

### チェックリスト

#### 運営用URL（/admin）

- ✅ ポケモンをクリックするとピックできる
- ✅ 試合終了時に「次の試合へ進む」ボタンが表示される
- ✅ 画面右上に運営・観戦URLが表示される
- ✅ ヘッダーに「👁️ 観戦モード」バッジが**表示されない**

#### 観戦用URL（/view）

- ✅ ヘッダーに「👁️ 観戦モード」バッジが表示される
- ✅ ポケモングリッドに「読み取り専用」表示
- ✅ ポケモンをクリックしても何も起こらない
- ✅ 試合終了時に「次の試合へ進む」ボタンが**表示されない**
- ✅ ブラウザコンソールに `Read-only mode` 警告が出る（クリック時）

---

## 🛠️ トラブルシューティング

### ❌ 「Draft not found」エラーが表示される

**原因**: 指定されたDraft IDが存在しない

**対処法**:
1. Draft IDが正しいか確認
2. Supabaseでデータを確認:
   ```sql
   SELECT id, created_at FROM drafts ORDER BY created_at DESC LIMIT 10;
   ```
3. 正しいIDで再度URLを生成

### ❌ 観戦側でピックできてしまう

**原因**: URLの `mode` が `view` になっていない

**対処法**:
1. URLを確認: `/draft/:id/view` になっているか
2. ブラウザのアドレスバーで直接確認
3. 正しいURLを再共有

### ❌ 観戦側にリアルタイム反映されない

**原因**: 現在の実装ではポーリングなし（手動リロードが必要）

**対処法**:
1. 観戦側でブラウザをリロード（F5）
2. 運営側の最新状態が表示される

**将来的な改善**:
- ポーリング機能追加（3秒ごとに自動更新）
- Supabase Realtime 使用

### ❌ 運営用URLが流出した場合

**対処法**:
1. **新しいドラフトを作成**:
   ```javascript
   localStorage.removeItem('current_draft_id')
   ```
   その後、`/draft` にアクセスして新規作成

2. **古いドラフトを削除**（Supabase Dashboard）:
   ```sql
   DELETE FROM drafts WHERE id = 'old-draft-id';
   ```

3. 新しい運営・観戦URLを生成して再共有

---

## 💡 ベストプラクティス

### 事前準備

1. **リハーサルを実施**
   - 運営用URLで全機能をテスト
   - 観戦用URLで制限を確認
   - 3試合分の動作確認

2. **URLをスプレッドシートで管理**
   ```
   | 大会名 | Draft ID | 運営URL | 観戦URL | 作成日時 |
   |--------|----------|---------|---------|----------|
   | 第1回  | xxx-xxx  | /admin  | /view   | 2025-01-15 |
   ```

3. **バックアップURLを用意**
   - 運営用URLを複数人で共有
   - メインPCが故障しても別PCから操作可能

### 大会中

1. **運営用URLは限定共有**
   - スタッフのみに限定
   - 配信画面に映らないよう注意

2. **観戦用URLは公開OK**
   - 配信のコメント欄に貼る
   - SNSで共有
   - 観客は自由にアクセス可能

3. **操作ログを確認**
   - ブラウザコンソールで保存成功を確認
   - `[saveDraftState] ✅ Successfully updated draft` が表示されればOK

### 大会後

1. **ドラフトデータをエクスポート**（Supabase Dashboard）:
   ```sql
   SELECT jsonb_pretty(state) FROM drafts WHERE id = 'your-draft-id';
   ```

2. **不要なドラフトを削除**（1週間以上経過したもの）:
   ```sql
   DELETE FROM drafts WHERE created_at < NOW() - INTERVAL '7 days';
   ```

---

## 📊 運用パターン例

### パターン1: オフライン大会

```
1. 会場のメインPCで運営用URLにアクセス
2. 観戦用URLをQRコード化してスクリーンに表示
3. 観客は各自のスマホでQRコードをスキャン
4. リアルタイムでドラフト状況を確認
```

### パターン2: オンライン配信

```
1. 運営PCで運営用URLにアクセス
2. 観戦用URLを配信のコメント欄・概要欄に貼り付け
3. OBSでブラウザソースとして観戦用URLを表示
4. 配信画面に常時ドラフト状況を表示
```

### パターン3: 複数会場同時開催

```
1. 各会場ごとに別のドラフトを作成（異なるDraft ID）
2. 各会場の運営用URLをそれぞれのスタッフに共有
3. 本部は全会場の観戦用URLをブックマーク
4. 複数タブで全会場のドラフト状況を同時監視
```

---

## 🔐 セキュリティに関する注意

### 現在の仕様

- **認証なし**: URLを知っている人全員がアクセス可能
- **RLSポリシー**: 開発用（全アクセス許可）
- **想定**: 信頼できる関係者間での運用

### 推奨事項

1. **運営用URLは秘密に保持**
   - プライベートチャットで共有
   - 公開チャンネルに投稿しない

2. **観戦用URLは自由に共有OK**
   - 読み取り専用なので安全
   - 操作されるリスクなし

3. **将来的な改善案**（本番運用時）:
   - 運営用URLに簡易パスワード追加
   - Supabase Auth 導入
   - RLSポリシーを認証ベースに変更

---

## ✅ 大会で安全に使える状態

以下の条件が満たされています:

- ✅ 運営と観戦でURLを分離
- ✅ 観戦側は完全に read-only
- ✅ 同じデータを共有（リアルタイム性）
- ✅ 既存ロジックを破壊せず実装
- ✅ 簡単な運用（URLを共有するだけ）

**これで大会運用準備完了です！**
